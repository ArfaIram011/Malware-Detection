from flask import Flask, request, render_template
from werkzeug.utils import secure_filename
import pandas as pd
import pickle
import warnings
warnings.filterwarnings('ignore')
import re

app = Flask(__name__)

model = pickle.load(open('final_model_z.pkl', 'rb'))

@app.route('/')
def home():
    return render_template('test.html')

@app.route('/predict',methods=['POST'])
def predict():
    '''
    For rendering results on HTML GUI
    '''

    apkpermissions = []
    dataset = pd.read_csv('Datasetx.csv')

    if request.method == 'POST':
        f = request.files['file']
        f.save(secure_filename(f.filename))
        #return 'file uploaded successfully'
        file1 = open(f.filename, "r")
        # file2 = open("getPermissions.txt", "w")
        for line in file1:
          if "android.permission" in str(line):
            permission = re.search("android\.permission\.[\w.]+", line).group()
            apkpermissions.append(permission)
            # file2.write(permission)
             # file2.close()
        datasetpermissions = dataset.columns
        arr = []

        for i in range(0, len(datasetpermissions) - 1):
            if datasetpermissions[i] in apkpermissions:
              arr.append(1)
            else:
              arr.append(0)
        prediction = model.predict([arr])      
        print('prediction value is ', prediction)
        if (prediction == 0):
           output = "NOT MALICIOUS APPLICATION"
        else:
           output = "MALICIOUS APPLICATION"
        return render_template('test.html', prediction_text='{}'.format(output))      


if __name__ == "__main__":
    app.run(debug=True)
